<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chronix Vault — Stock Simulation</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --bg1: linear-gradient(135deg,#0f172a 0%, #102a43 60%);
    --card:#0b1220;
    --accent:#4CAF50;
    --accent-2:#A076F9;
    --muted:#94a3b8;
    --glass: rgba(255,255,255,0.04);
    --glass-2: rgba(255,255,255,0.02);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: var(--bg1);
    color: #E6EEF8;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.4;
    padding:28px;
  }
  .container{max-width:1100px;margin:0 auto;padding:18px}
  header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
  .logo{
    width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;font-weight:800;color:#021B09;font-size:20px;
    box-shadow:0 8px 28px rgba(10,20,40,.5);
  }
  h1{margin:0;font-size:28px;letter-spacing:-0.02em}
  .tag{color:var(--muted);font-size:14px;margin-top:4px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:20px;margin-top:18px}
  .panel{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:0 6px 24px rgba(0,0,0,.45)}
  .small{padding:12px}
  .lead{font-size:18px;margin-bottom:12px}
  .hero-cta{display:flex;gap:10px;margin-top:14px}
  .btn{
    background:linear-gradient(90deg,var(--accent),#2bb673);
    border:0;padding:10px 14px;border-radius:10px;color:#021204;font-weight:700;cursor:pointer;
    box-shadow:0 8px 22px rgba(75,187,118,.12);
  }
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--muted);padding:10px 12px;border-radius:10px;cursor:pointer}
  .features{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .feat{flex:1 1 140px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px}
  .feat h4{margin:0 0 6px 0;font-size:14px}
  .feat p{margin:0;color:var(--muted);font-size:13px}
  .flow-wrap{display:flex;gap:12px;align-items:center;justify-content:center;padding:6px;background:var(--glass-2);border-radius:10px}
  svg.flow{width:100%;height:160px}
  .demo-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .demo-stage{display:flex;gap:10px;align-items:center}
  .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 6px 18px rgba(76,175,80,.12)}
  .vault-list{display:flex;flex-direction:column;gap:12px;margin-top:8px}
  .vault{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);
    display:flex;flex-direction:column;
  }
  .vault-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .vault-title{font-weight:700}
  .vault-meta{font-size:13px;color:var(--muted)}
  .progress-bar{height:12px;background:rgba(255,255,255,0.04);border-radius:8px;margin-top:10px;position:relative;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%;transition:width .6s cubic-bezier(.2,.9,.3,1);box-shadow:0 6px 18px rgba(160,100,255,.08)}
  .vault-actions{display:flex;gap:8px;margin-top:10px}
  .input{background:#0b1230;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:#e6eef8;min-width:110px}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
  .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .badge{
    background:linear-gradient(90deg,#fff2 0%,#fff0 60%);
    padding:6px 8px;border-radius:999px;font-weight:700;color:#fffb;
    border:1px solid rgba(255,255,255,0.02);font-size:12px
  }
  .right-title{font-size:16px;margin-bottom:8px}
  .kpi{display:flex;gap:12px;align-items:center;margin-bottom:10px}
  .kpi .big{font-size:20px;font-weight:800}
  .card-ghost{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  @media (max-width:980px){
    .grid{grid-template-columns:1fr; }
    .logo{width:58px;height:58px;font-size:18px}
  }

  /* Stock-specific styles */
  .stock-panel {
    background: #0b1220;
    padding: 18px;
    border-radius: 14px;
    box-shadow: 0 6px 24px rgba(0,0,0,.45);
    margin-top: 18px;
  }
  .chart-container {
    width: 100%;
    height: 400px;
  }
  .stock-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    align-items: center;
    justify-content: center;
  }
  .stock-info {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 10px;
    text-align: center;
  }
  .index-panel {
    display: flex;
    justify-content: space-around;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  .index-card {
    flex: 1 1 200px;
    padding: 12px;
    background: var(--glass-2);
    border-radius: 10px;
  }
  .index-name { font-weight: 700; font-size: 1rem; }
  .index-value { font-size: 1.5rem; font-weight: 800; }
  .index-change { font-size: 0.9rem; margin-top: 4px; }
  .positive { color: #4CAF50; }
  .negative { color: #f44336; }
  .company-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
    justify-content: center;
  }
  .company-btn {
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.05);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s ease;
  }
  .company-btn.active {
    background: var(--accent);
    color: #021204;
    border-color: var(--accent);
  }
  .portfolio-panel {
    display: none;
    flex-direction: column;
    gap: 12px;
  }
  .portfolio-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }
  .portfolio-table th, .portfolio-table td {
    padding: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    text-align: left;
  }
  .portfolio-table th {
    font-weight: 700;
  }
  .message-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background-color: var(--card);
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    text-align: center;
    max-width: 400px;
    width: 90%;
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">CV</div>
      <div>
        <h1>Chronix Vault</h1>
        <div class="tag">Savings + Smart Investing + Gamification — made for students (18–25)</div>
      </div>
    </header>

    <main class="grid">
      <!-- Left: content + demo -->
      <section class="panel">
        <div class="lead">Make saving sticky: auto-roundups, time-locked vaults, AI nudges (future), and gamified rewards to convert pocket spend into future wealth.</div>

        <div class="hero-cta">
          <button class="btn" id="tryDemoBtn">Try the Prototype →</button>
          <button class="btn-ghost" id="viewFlowBtn">View Flowchart</button>
        </div>

        <div style="margin-top:16px">
          <div class="small card-ghost">
            <strong>Key features</strong>
            <div class="features" style="margin-top:10px">
              <div class="feat"><h4>Time-locked + Flexible</h4><p>Discipline with smart withdrawal rules.</p></div>
              <div class="feat"><h4>AI Guided</h4><p>Student-friendly, risk-based suggestions (MVP: simulated).</p></div>
              <div class="feat"><h4>Gamified Discipline</h4><p>Badges, streaks & leaderboards to keep users engaged.</p></div>
              <div class="feat"><h4>Learn + Earn</h4><p>Micro-courses that reward progress.</p></div>
            </div>
          </div>
        </div>

        <!-- Flowchart (hidden by default) -->
        <div id="flowchart" style="margin-top:14px;display:none">
          <div style="font-weight:800;margin-bottom:8px">Prototype Flow</div>
          <div class="flow-wrap">
            <svg class="flow" viewBox="0 0 900 160" xmlns="http://www.w3.org/2000/svg" aria-hidden>
              <defs>
                <linearGradient id="g1" x1="0" x2="1">
                  <stop offset="0" stop-color="#4CAF50"/>
                  <stop offset="1" stop-color="#A076F9"/>
                </linearGradient>
              </defs>
              <rect x="10" y="18" width="160" height="56" rx="8" fill="#071126" stroke="rgba(255,255,255,0.03)"/>
              <text x="90" y="52" font-size="13" fill="#dff" text-anchor="middle" font-weight="700">Login / Sign up</text>
              <rect x="210" y="18" width="170" height="56" rx="8" fill="#071126" stroke="rgba(255,255,255,0.03)"/>
              <text x="295" y="52" font-size="13" fill="#dff" text-anchor="middle" font-weight="700">Dashboard / Deposit</text>
              <rect x="430" y="18" width="180" height="56" rx="8" fill="#071126" stroke="rgba(255,255,255,0.03)"/>
              <text x="520" y="52" font-size="13" fill="#dff" text-anchor="middle" font-weight="700">AI Risk / Suggestions</text>
              <rect x="650" y="18" width="220" height="56" rx="8" fill="#071126" stroke="rgba(255,255,255,0.03)"/>
              <text x="760" y="52" font-size="13" fill="#dff" text-anchor="middle" font-weight="700">Funds → Time-locked vaults</text>
              <path d="M170 46 H210" stroke="url(#g1)" stroke-width="4" fill="none" stroke-linecap="round"/>
              <path d="M380 46 H430" stroke="url(#g1)" stroke-width="4" fill="none" stroke-linecap="round"/>
              <path d="M610 46 H650" stroke="url(#g1)" stroke-width="4" fill="none" stroke-linecap="round"/>
              <rect x="120" y="108" width="160" height="36" rx="8" fill="#071126" stroke="rgba(255,255,255,0.03)"/>
              <text x="200" y="130" font-size="12" fill="#dff" text-anchor="middle">Withdraw</text>
              <rect x="360" y="108" width="200" height="36" rx="8" fill="#071126" stroke="rgba(255,255,255,0.03)"/>
              <text x="460" y="130" font-size="12" fill="#dff" text-anchor="middle">Financial Literacy Hub</text>
              <rect x="640" y="108" width="200" height="36" rx="8" fill="#071126" stroke="rgba(255,255,255,0.03)"/>
              <text x="740" y="130" font-size="12" fill="#dff" text-anchor="middle">Gamification / Leaderboard</text>
              <path d="M90 74 V108" stroke="rgba(255,255,255,.06)" stroke-width="2" fill="none"/>
              <path d="M295 74 V108" stroke="rgba(255,255,255,.06)" stroke-width="2" fill="none"/>
              <path d="M760 74 V108" stroke="rgba(255,255,255,.06)" stroke-width="2" fill="none"/>
            </svg>
          </div>
        </div>

        <!-- Interactive demo -->
        <div id="demo" style="margin-top:18px">
          <div class="demo-header">
            <div class="demo-stage">
              <div class="dot"></div>
              <div style="font-weight:800">Interactive Prototype</div>
            </div>
            <div style="color:var(--muted);font-size:13px">Simulated deposits • No real payments</div>
          </div>
          <div class="vault-controls small card-ghost" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <input id="vaultName" class="input" placeholder="Vault name e.g., Laptop fund">
            <input id="goalAmt" class="input" placeholder="Goal ₹ (e.g., 15000)" type="number">
            <button class="btn" onclick="createVault()">Create vault</button>
            <button class="btn-ghost" onclick="seedExample()">Load example</button>
          </div>
          <div id="vaults" class="vault-list"></div>
          <div style="margin-top:12px;color:var(--muted);font-size:13px">
            Tip: Use <strong>Parent deposit</strong> to simulate a guardian funding the vault. Badges are awarded automatically on milestones.
          </div>
        </div>
      </section>

      <!-- Right column -->
      <aside class="panel">
        <div class="right-title">Pitch Snapshot</div>
        <div style="font-size:14px;color:var(--muted);margin-bottom:12px">
          <strong>One-liner:</strong> Turn pocket money into future wealth with auto-saves, micro-investing suggestions & gamified learning.
        </div>
        <div class="card-ghost" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><small style="color:var(--muted)">Primary</small><div class="big" style="font-size:16px;font-weight:800">Students 18–25</div></div>
            <div style="text-align:right;color:var(--muted)"><small>Secondary</small><div>Parents & EdTech</div></div>
          </div>
        </div>
        <div style="margin-bottom:12px">
          <div class="kpi"><div><small style="color:var(--muted)">Projected CAC</small><div class="big">₹40</div></div><div style="margin-left:auto;color:var(--muted)">Low-cost digital onboarding</div></div>
          <div class="kpi"><div><small style="color:var(--muted)">Monetization</small><div class="big">Partnerships</div></div><div style="margin-left:auto;color:var(--muted)">SIP referrals • Premium coach</div></div>
        </div>
        <div class="card-ghost">
          <div style="font-weight:700;margin-bottom:8px">Demo script (90s)</div>
          <ol style="color:var(--muted);padding-left:18px">
            <li>Problem: Students struggle to save — 10s</li>
            <li>Solution: Chronix Vault — 20s</li>
            <li>Demo create vault + deposit + badge — 40s</li>
            <li>Ask: mentorship & partners — 20s</li>
          </ol>
        </div>
        <div style="margin-top:12px" class="card-ghost">
          <div style="font-weight:700">Presentation Tips</div>
          <ul style="color:var(--muted);padding-left:18px;margin-top:8px;">
            <li>Keep demo <strong>≤90s</strong></li>
            <li>Show user flow, not tech depth</li>
            <li>Use screenshots as fallback</li>
          </ul>
        </div>
      </aside>
    </main>

    <!-- Stock Market Section -->
    <section class="stock-panel mt-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Stock Simulation</h2>
        <button id="viewPortfolioBtn" class="btn text-sm px-4 py-2">View Portfolio</button>
      </div>

      <!-- Indices Section -->
      <div id="indices-section" class="index-panel">
        <div class="index-card">
          <div class="index-name">Nifty 50</div>
          <div class="index-value" id="nifty50-value"></div>
          <div class="index-change text-sm" id="nifty50-change"></div>
        </div>
        <div class="index-card">
          <div class="index-name">Nifty Bank</div>
          <div class="index-value" id="niftybank-value"></div>
          <div class="index-change text-sm" id="niftybank-change"></div>
        </div>
      </div>

      <!-- Main Trading View -->
      <div id="trading-view">
        <div class="stock-info" id="stock-title"></div>
        <div class="chart-container">
          <canvas id="stockChart"></canvas>
        </div>
        
        <div id="company-options" class="company-options"></div>

        <div class="stock-actions mt-4 flex-wrap">
          <div class="flex items-center space-x-2 my-2">
            <input id="buy-shares" type="number" placeholder="Shares to buy" class="input text-sm w-32">
            <button class="btn text-xs px-4 py-2 rounded-lg" onclick="buyStock()">Buy</button>
          </div>
          <div class="flex items-center space-x-2 my-2">
            <input id="sell-shares" type="number" placeholder="Shares to sell" class="input text-sm w-32">
            <button class="btn text-xs px-4 py-2 rounded-lg" onclick="sellStock()">Sell</button>
          </div>
          <div class="flex items-center space-x-2 my-2">
            <input id="stop-loss-price" type="number" placeholder="Stop-loss price" class="input text-sm w-32">
            <button class="btn-ghost text-xs px-4 py-2 rounded-lg" onclick="setStopLoss()">Set Stop-Loss</button>
          </div>
        </div>

        <div id="stock-status" class="text-center mt-4 text-sm text-gray-400">
          Current Price: <span id="current-price">₹0.00</span> | Shares Owned: <span id="shares-owned">0</span> | P&L: <span id="pnl">₹0.00</span>
        </div>
      </div>

      <!-- Portfolio View -->
      <div id="portfolio-view" class="portfolio-panel">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-bold">My Portfolio</h3>
          <button id="backToTradingBtn" class="btn-ghost text-sm px-4 py-2">← Back to Trading</button>
        </div>
        <div class="flex justify-around text-center my-4">
          <div>
            <div class="text-xs text-gray-400">Total Investment</div>
            <div class="font-bold text-lg" id="total-investment">₹0.00</div>
          </div>
          <div>
            <div class="text-xs text-gray-400">Total Return</div>
            <div class="font-bold text-lg" id="total-return">₹0.00</div>
          </div>
          <div>
            <div class="text-xs text-gray-400">Today's P&L</div>
            <div class="font-bold text-lg" id="todays-pnl">₹0.00</div>
          </div>
        </div>
        <table class="portfolio-table">
          <thead>
            <tr>
              <th>Company</th>
              <th>Shares</th>
              <th>Avg Price</th>
              <th>Current Value</th>
              <th>Today's P&L</th>
            </tr>
          </thead>
          <tbody id="portfolio-body">
            <!-- Portfolio items will be rendered here -->
          </tbody>
        </table>
      </div>

    </section>

    <footer>
      Prototype built for hackathon demo • Chronix Vault — <span style="color:var(--muted)">Simulated</span>
    </footer>
  </div>

<div id="messageModal" class="message-modal">
  <div class="modal-content">
    <p id="modal-text" class="text-white mb-4"></p>
    <button class="btn px-6 py-2" onclick="hideModal()">OK</button>
  </div>
</div>

<script>
/*
  Chronix Vault -- interactive frontend prototype
  - LocalStorage used to persist vaults
  - Create vault, deposit, parent deposit
  - Badges on milestones (25%, 50%, 100%)
*/
const KEY = 'chronix_vaults_v2';
const STOCK_KEY = 'chronix_stock_data_v2';
const companyColors = ['#A076F9', '#4CAF50', '#2196F3', '#FF9800', '#F44336', '#9C27B0', '#673AB7', '#FFEB3B'];
let currentTicker = 'RELIANCE';
let stockChart;

const initialMarketData = {
  indices: {
    'NIFTY50': { price: 23600, initialPrice: 23600, data: [], labels: [] },
    'NIFTYBANK': { price: 51200, initialPrice: 51200, data: [], labels: [] }
  },
  companies: {
    'RELIANCE': { price: 1415.00, initialPrice: 1415.00, data: [], labels: [], ownedShares: 0, buyPrice: 0, stopLossPrice: 0 },
    'SBILIFE': { price: 1821.80, initialPrice: 1821.80, data: [], labels: [], ownedShares: 0, buyPrice: 0, stopLossPrice: 0 },
    'M&M': { price: 3642.20, initialPrice: 3642.20, data: [], labels: [], ownedShares: 0, buyPrice: 0, stopLossPrice: 0 },
    'BDL': { price: 1610.20, initialPrice: 1610.20, data: [], labels: [], ownedShares: 0, buyPrice: 0, stopLossPrice: 0 },
    'HDFCBANK': { price: 976.90, initialPrice: 976.90, data: [], labels: [], ownedShares: 0, buyPrice: 0, stopLossPrice: 0 },
    'INFY': { price: 1540.60, initialPrice: 1540.60, data: [], labels: [], ownedShares: 0, buyPrice: 0, stopLossPrice: 0 },
    'KOTAKBANK': { price: 2054.60, initialPrice: 2054.60, data: [], labels: [], ownedShares: 0, buyPrice: 0, stopLossPrice: 0 },
    'DMART': { price: 4760.30, initialPrice: 4760.30, data: [], labels: [], ownedShares: 0, buyPrice: 0, stopLossPrice: 0 }
  },
  portfolio: {}
};

let marketData = initialMarketData;

function formatCurrency(n) { return '₹' + Number(n).toLocaleString('en-IN', { maximumFractionDigits: 2 }); }

function loadVaults() { try { return JSON.parse(localStorage.getItem(KEY) || '[]') } catch (e) { return [] } }
function saveVaults(v) { localStorage.setItem(KEY, JSON.stringify(v)) }
function loadMarketData() { try { marketData = JSON.parse(localStorage.getItem(STOCK_KEY)) || initialMarketData } catch (e) { marketData = initialMarketData } }
function saveMarketData() { localStorage.setItem(STOCK_KEY, JSON.stringify(marketData)) }

function showModal(text) {
  document.getElementById('modal-text').innerText = text;
  document.getElementById('messageModal').style.display = 'flex';
}

function hideModal() {
  document.getElementById('messageModal').style.display = 'none';
}

function renderVaults() {
  const container = document.getElementById('vaults');
  const vaults = loadVaults();
  container.innerHTML = '';
  if (vaults.length === 0) {
    container.innerHTML = `<div class="card-ghost" style="padding:18px;color:var(--muted)">No vaults yet — create one or click <strong>Load example</strong></div>`;
    return;
  }
  vaults.forEach((v, i) => {
    const pct = Math.min(100, Math.round((v.balance / Math.max(1, v.goal)) * 100));
    const badges = [];
    if (pct >= 25) badges.push('Getting Started');
    if (pct >= 50) badges.push('Halfway Hero');
    if (pct >= 100) badges.push('Goal Achieved');
    const badgeHtml = badges.map(b => `<span class="badge">${b}</span>`).join('');
    const html = `
      <div class="vault" data-index="${i}">
        <div class="vault-top">
          <div>
            <div class="vault-title">${escapeHtml(v.name)}</div>
            <div class="vault-meta">${formatCurrency(v.balance)} • Goal ${formatCurrency(v.goal)} • ${pct}%</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px;color:var(--muted)">${v.locked ? 'Time-Locked' : 'Flexible'}</div>
            <div style="margin-top:8px">${badgeHtml}</div>
          </div>
        </div>
        <div class="progress-bar" aria-hidden><div class="progress-fill" style="width:${pct}%"></div></div>
        <div class="vault-actions">
          <input class="input deposit-amt" id="dep${i}" placeholder="Deposit ₹" type="number" />
          <button class="btn" onclick="deposit(${i})">Deposit</button>
          <button class="ghost" onclick="parentDeposit(${i})">Parent deposit</button>
          <button class="ghost" onclick="toggleLock(${i})">${v.locked ? 'Unlock' : 'Lock'}</button>
          <button class="ghost" onclick="withdraw(${i})">Withdraw</button>
        </div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
  })
}

function escapeHtml(s) { return String(s).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])) }
function createVault() {
  const name = document.getElementById('vaultName').value.trim() || 'My Vault';
  const goal = Math.max(100, Number(document.getElementById('goalAmt').value) || 1000);
  const v = loadVaults();
  v.push({ name, goal, balance: 0, locked: true, createdAt: Date.now() });
  saveVaults(v);
  renderVaults();
  document.getElementById('vaultName').value = '';
  document.getElementById('goalAmt').value = '';
}

function seedExample() {
  const examples = [
    { name: 'Laptop Fund', goal: 45000, balance: 3000, locked: true },
    { name: 'Trip 2026', goal: 20000, balance: 8000, locked: true },
    { name: 'Emergency', goal: 8000, balance: 1500, locked: false },
  ];
  saveVaults(examples);
  renderVaults();
}

function deposit(i) {
  const input = document.getElementById('dep' + i);
  if (!input) return;
  const amt = Number(input.value) || 0;
  if (amt <= 0) { showModal('Enter deposit amount'); return; }
  const v = loadVaults();
  v[i].balance = (v[i].balance || 0) + amt;
  saveVaults(v); renderVaults();
  showModal('Deposit successful');
  input.value = '';
}

function parentDeposit(i) {
  const raw = 1000; // hardcoded for demo
  const amt = Number(raw) || 0;
  if (amt <= 0) return;
  const v = loadVaults();
  v[i].balance = (v[i].balance || 0) + amt;
  saveVaults(v); renderVaults();
  showModal('Parent deposit added');
}

function toggleLock(i) {
  const v = loadVaults();
  v[i].locked = !v[i].locked;
  saveVaults(v); renderVaults();
  showModal(v[i].locked ? 'Vault locked' : 'Vault unlocked');
}

function withdraw(i) {
  const v = loadVaults();
  if (v[i].locked) {
    showModal('This vault is time-locked. You cannot withdraw.');
    return;
  }
  const amt = v[i].balance / 2;
  if (amt <= 0) { showModal('Insufficient balance'); return; }
  v[i].balance -= amt;
  saveVaults(v); renderVaults();
  showModal('Withdrawn ' + formatCurrency(amt));
}

// --- Stock Simulation Logic ---
function updateAllPrices() {
  // Update Indices
  for (const ticker in marketData.indices) {
    let index = marketData.indices[ticker];
    let step = (Math.random() - 0.5) * 10;
    index.price = Math.max(1, index.price + step);
    index.data.push(index.price);
    index.labels.push(index.labels.length);
    if (index.data.length > 100) {
      index.data.shift();
      index.labels.shift();
    }
  }

  // Update Companies
  for (const ticker in marketData.companies) {
    let company = marketData.companies[ticker];
    let step = (Math.random() - 0.5) * (company.initialPrice * 0.005);
    company.price = Math.max(1, company.price + step);
    company.data.push(company.price);
    company.labels.push(company.labels.length);
    if (company.data.length > 100) {
      company.data.shift();
      company.labels.shift();
    }
  }
  saveMarketData();
  updateUI();
}

function updateUI() {
  // Update Indices
  document.getElementById('nifty50-value').innerText = formatCurrency(marketData.indices['NIFTY50'].price);
  const nifty50Change = marketData.indices['NIFTY50'].price - marketData.indices['NIFTY50'].initialPrice;
  document.getElementById('nifty50-change').innerText = `${nifty50Change >= 0 ? '+' : ''}${nifty50Change.toFixed(2)}`;
  document.getElementById('nifty50-change').className = `index-change text-sm ${nifty50Change >= 0 ? 'positive' : 'negative'}`;

  document.getElementById('niftybank-value').innerText = formatCurrency(marketData.indices['NIFTYBANK'].price);
  const niftybankChange = marketData.indices['NIFTYBANK'].price - marketData.indices['NIFTYBANK'].initialPrice;
  document.getElementById('niftybank-change').innerText = `${niftybankChange >= 0 ? '+' : ''}${niftybankChange.toFixed(2)}`;
  document.getElementById('niftybank-change').className = `index-change text-sm ${niftybankChange >= 0 ? 'positive' : 'negative'}`;

  // Update Main Trading View
  const company = marketData.companies[currentTicker];
  if (company) {
    document.getElementById('stock-title').innerText = `${currentTicker}`;
    document.getElementById('current-price').innerText = formatCurrency(company.price);
    document.getElementById('shares-owned').innerText = company.ownedShares;
    const pnl = company.ownedShares > 0 ? (company.price - company.buyPrice) * company.ownedShares : 0;
    document.getElementById('pnl').innerText = formatCurrency(pnl);
    if (stockChart) {
      stockChart.data.datasets[0].data = company.data;
      stockChart.data.labels = company.labels;
      stockChart.data.datasets[0].borderColor = companyColors[Object.keys(marketData.companies).indexOf(currentTicker)];
      stockChart.update('none');
    }
  }
  
  // Check stop-loss
  if (company.stopLossPrice > 0 && company.price <= company.stopLossPrice) {
    sellStockForStopLoss(currentTicker);
  }
}

function initChart() {
  const ctx = document.getElementById('stockChart').getContext('2d');
  stockChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Stock Price',
        data: [],
        borderColor: '#A076F9',
        backgroundColor: 'rgba(160, 118, 249, 0.2)',
        borderWidth: 2,
        fill: true,
        tension: 0.2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        x: { display: false },
        y: {
          title: { display: true, text: "Price (₹)", color: '#94a3b8' },
          beginAtZero: false,
          grid: { color: 'rgba(255,255,255,0.05)' },
          ticks: { color: '#94a3b8' }
        }
      },
      plugins: { legend: { display: false } }
    }
  });
}

function renderCompanyOptions() {
  const container = document.getElementById('company-options');
  container.innerHTML = '';
  Object.keys(marketData.companies).forEach(ticker => {
    const btn = document.createElement('button');
    btn.innerText = ticker;
    btn.className = `company-btn ${ticker === currentTicker ? 'active' : ''}`;
    btn.onclick = () => switchCompany(ticker);
    container.appendChild(btn);
  });
}

function switchCompany(ticker) {
  currentTicker = ticker;
  renderCompanyOptions();
  updateUI();
}

function buyStock() {
  const shares = Number(document.getElementById('buy-shares').value);
  if (shares <= 0 || !Number.isInteger(shares)) {
    showModal('Please enter a valid whole number of shares to buy.');
    return;
  }
  const company = marketData.companies[currentTicker];
  const cost = shares * company.price;
  const vaults = loadVaults();
  const mainVault = vaults[0];

  if (!mainVault || mainVault.balance < cost) {
    showModal('Insufficient funds in your main vault to make this purchase.');
    return;
  }

  mainVault.balance -= cost;
  saveVaults(vaults);
  renderVaults();

  if (!marketData.portfolio[currentTicker]) {
    marketData.portfolio[currentTicker] = {
      shares: 0,
      buyPrice: 0,
      initialPrice: company.initialPrice
    };
  }

  const holding = marketData.portfolio[currentTicker];
  const totalShares = holding.shares + shares;
  const totalCost = (holding.shares * holding.buyPrice) + cost;
  holding.shares = totalShares;
  holding.buyPrice = totalCost / totalShares;

  company.ownedShares = holding.shares;
  company.buyPrice = holding.buyPrice;
  
  showModal(`Bought ${shares} shares of ${currentTicker} for ${formatCurrency(cost)}.`);
  document.getElementById('buy-shares').value = '';
  saveMarketData();
  updateUI();
  renderPortfolio();
}

function sellStock() {
  const shares = Number(document.getElementById('sell-shares').value);
  if (shares <= 0 || !Number.isInteger(shares)) {
    showModal('Please enter a valid whole number of shares to sell.');
    return;
  }
  const company = marketData.companies[currentTicker];
  if (shares > company.ownedShares) {
    showModal('You cannot sell more shares than you own.');
    return;
  }

  const saleAmount = shares * company.price;
  const vaults = loadVaults();
  const mainVault = vaults[0];

  if (mainVault) {
    mainVault.balance += saleAmount;
    saveVaults(vaults);
    renderVaults();
  }

  const holding = marketData.portfolio[currentTicker];
  holding.shares -= shares;
  company.ownedShares = holding.shares;
  if (holding.shares === 0) {
    delete marketData.portfolio[currentTicker];
    company.buyPrice = 0;
  }
  
  showModal(`Sold ${shares} shares of ${currentTicker} for ${formatCurrency(saleAmount)}.`);
  document.getElementById('sell-shares').value = '';
  saveMarketData();
  updateUI();
  renderPortfolio();
}

function sellStockForStopLoss(ticker) {
  const company = marketData.companies[ticker];
  const holding = marketData.portfolio[ticker];
  if (!holding) return;

  const shares = holding.shares;
  const saleAmount = shares * company.price;
  const vaults = loadVaults();
  const mainVault = vaults[0];

  if (mainVault) {
    mainVault.balance += saleAmount;
    saveVaults(vaults);
    renderVaults();
  }

  company.ownedShares = 0;
  company.buyPrice = 0;
  company.stopLossPrice = 0;
  delete marketData.portfolio[ticker];
  
  showModal(`Stop-loss triggered for ${ticker}! All shares sold to prevent major loss.`);
  saveMarketData();
  updateUI();
  renderPortfolio();
}

function setStopLoss() {
  const price = Number(document.getElementById('stop-loss-price').value);
  const company = marketData.companies[currentTicker];
  if (price <= 0 || price >= company.price) {
    showModal('Stop-loss price must be a positive value below the current price.');
    return;
  }
  company.stopLossPrice = price;
  showModal(`Stop-loss set for ${currentTicker} at ${formatCurrency(price)}.`);
  saveMarketData();
}

function renderPortfolio() {
  const body = document.getElementById('portfolio-body');
  body.innerHTML = '';
  
  let totalInvestment = 0;
  let totalCurrentValue = 0;
  let todaysPnl = 0;

  for (const ticker in marketData.portfolio) {
    const holding = marketData.portfolio[ticker];
    const company = marketData.companies[ticker];
    const currentValue = holding.shares * company.price;
    const dayPnl = holding.shares * (company.price - company.initialPrice);

    totalInvestment += holding.shares * holding.buyPrice;
    totalCurrentValue += currentValue;
    todaysPnl += dayPnl;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${ticker}</td>
      <td>${holding.shares}</td>
      <td>${formatCurrency(holding.buyPrice)}</td>
      <td>${formatCurrency(currentValue)}</td>
      <td class="${dayPnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(dayPnl)}</td>
    `;
    body.appendChild(row);
  }

  const totalReturn = totalCurrentValue - totalInvestment;

  document.getElementById('total-investment').innerText = formatCurrency(totalInvestment);
  document.getElementById('total-return').innerText = formatCurrency(totalReturn);
  document.getElementById('todays-pnl').innerText = formatCurrency(todaysPnl);
  document.getElementById('todays-pnl').className = `font-bold text-lg ${todaysPnl >= 0 ? 'positive' : 'negative'}`;
  document.getElementById('total-return').className = `font-bold text-lg ${totalReturn >= 0 ? 'positive' : 'negative'}`;
}

document.getElementById('viewPortfolioBtn').addEventListener('click', () => {
  document.getElementById('trading-view').style.display = 'none';
  document.getElementById('indices-section').style.display = 'none';
  document.getElementById('portfolio-view').style.display = 'flex';
  renderPortfolio();
});

document.getElementById('backToTradingBtn').addEventListener('click', () => {
  document.getElementById('trading-view').style.display = 'block';
  document.getElementById('indices-section').style.display = 'flex';
  document.getElementById('portfolio-view').style.display = 'none';
});

window.onload = function() {
  loadVaults();
  renderVaults();
  loadMarketData();
  initChart();
  renderCompanyOptions();
  setInterval(updateAllPrices, 500);
}

</script>
</body>
</html>
